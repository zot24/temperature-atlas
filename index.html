<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Global Temperature Atlas</title>
    <!-- MapLibre GL JS (with fallback to cdnjs if unpkg is blocked) -->
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <script>
        if (!window.maplibregl) {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/4.1.2/maplibre-gl.js"><\/script>');
        }
    </script>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/4.1.2/maplibre-gl.css" rel="stylesheet" />

    <link
        href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);

            --ui-pad: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Instrument Sans', sans-serif;
            background: #0a0e17;
        }

        #map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #temp-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            mix-blend-mode: multiply;
            transition: opacity 120ms ease;
        }

        .overlay {
            position: fixed;
            z-index: 1000;
            background: rgba(18, 26, 43, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: #e8edf5;
            backdrop-filter: blur(20px);
        }

        .logo {
            top: calc(var(--ui-pad) + var(--safe-top));
            left: calc(var(--ui-pad) + var(--safe-left));
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }

        .logo-text span {
            color: #8892a6;
            font-weight: 400;
        }

        .zoom-controls {
            top: calc(90px + var(--safe-top));
            left: calc(var(--ui-pad) + var(--safe-left));
            padding: 0;
        }

        .zoom-btn {
            display: block;
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: #e8edf5;
            font-size: 20px;
            cursor: pointer;
        }

        .zoom-btn:first-child {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .zoom-btn:hover {
            background: #1a2540;
        }

        .month-display {
            top: calc(var(--ui-pad) + var(--safe-top));
            right: calc(var(--ui-pad) + var(--safe-right));
        }

        .month-label {
            font-size: 10px;
            color: #5a6478;
            text-transform: uppercase;
        }

        .month-value {
            font-size: 20px;
            font-weight: 500;
            color: #00d4ff;
            font-family: 'JetBrains Mono', monospace;
        }

        .stats-panel {
            top: calc(180px + var(--safe-top));
            left: calc(var(--ui-pad) + var(--safe-left));
            min-width: 160px;
        }

        .stats-title {
            font-size: 10px;
            color: #5a6478;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 12px;
            color: #8892a6;
        }

        .stat-value {
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.hot {
            color: #ff6b6b;
        }

        .stat-value.cold {
            color: #00d4ff;
        }

        .stat-value.avg {
            color: #ffe566;
        }

        .bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 20px 30px calc(25px + var(--safe-bottom));
            padding-left: calc(30px + var(--safe-left));
            padding-right: calc(30px + var(--safe-right));
            background: linear-gradient(to top, rgba(10, 14, 23, 0.98), rgba(10, 14, 23, 0.7) 70%, transparent);
        }

        .slider-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .month-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .month-labels span {
            font-size: 11px;
            color: #5a6478;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .month-labels span:hover {
            background: #1a2540;
            color: #e8edf5;
        }

        .month-labels span.active {
            background: rgba(0, 212, 255, 0.15);
            color: #00d4ff;
        }

        .slider-track {
            position: relative;
            height: 6px;
            background: #1a2540;
            border-radius: 3px;
            margin-bottom: 15px;
        }

        .slider-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ffcc);
            border-radius: 3px;
        }

        #month-slider {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            margin: 0;
        }

        #month-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            margin-top: -5px;
        }

        .legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .legend-label {
            font-size: 10px;
            color: #5a6478;
            text-transform: uppercase;
        }

        .legend-bar {
            width: 200px;
            height: 8px;
            background: linear-gradient(90deg, #0044cc, #00ccff, #88ff44, #ffcc00, #ff4400);
            border-radius: 4px;
        }

        .loading-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(18, 26, 43, 0.95);
            padding: 20px 30px;
            border-radius: 12px;
            color: #e8edf5;
            z-index: 2000;
            display: none;
        }

        /* Mobile / small screens */
        @media (max-width: 600px) {
            :root {
                --ui-pad: 12px;
            }

            .overlay {
                padding: 10px 12px;
                border-radius: 10px;
            }

            .logo-text {
                font-size: 16px;
            }

            .logo-icon {
                font-size: 20px;
            }

            .zoom-controls {
                top: calc(70px + var(--safe-top));
            }

            .zoom-btn {
                width: 44px;
                height: 44px;
                font-size: 22px;
            }

            .month-value {
                font-size: 18px;
            }

            .stats-panel {
                top: calc(110px + var(--safe-top));
                left: calc(var(--ui-pad) + var(--safe-left));
                right: calc(var(--ui-pad) + var(--safe-right));
                min-width: 0;
            }

            .month-labels {
                justify-content: flex-start;
                gap: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 4px;
            }

            .month-labels span {
                flex: 0 0 auto;
            }

            .bottom-panel {
                padding: 14px 14px calc(14px + var(--safe-bottom));
                padding-left: calc(14px + var(--safe-left));
                padding-right: calc(14px + var(--safe-right));
            }

            .legend {
                flex-wrap: wrap;
                gap: 10px;
            }

            .legend-bar {
                width: min(180px, 55vw);
            }

            #month-slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
                margin-top: -9px;
            }

            #month-slider::-moz-range-thumb {
                width: 24px;
                height: 24px;
                border: none;
                background: #fff;
                border-radius: 50%;
                cursor: grab;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }
        }
    </style>
</head>

<body>
    <div id="map-container">
        <div id="map"></div>
        <canvas id="temp-canvas"></canvas>
    </div>

    <div class="overlay logo">
        <span class="logo-icon">ðŸŒ¡</span>
        <div class="logo-text">Temperature <span>Atlas</span></div>
    </div>

    <div class="overlay zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">âˆ’</button>
    </div>

    <div class="overlay month-display">
        <div class="month-label">Viewing</div>
        <div class="month-value" id="current-month">January</div>
    </div>

    <div class="overlay stats-panel">
        <div class="stats-title">Statistics</div>
        <div class="stat-item"><span class="stat-label">Hottest</span><span class="stat-value hot"
                id="stat-hottest">--</span></div>
        <div class="stat-item"><span class="stat-label">Coldest</span><span class="stat-value cold"
                id="stat-coldest">--</span></div>
        <div class="stat-item"><span class="stat-label">Average</span><span class="stat-value avg"
                id="stat-average">--</span></div>
    </div>

    <div class="bottom-panel">
        <div class="slider-container">
            <div class="month-labels" id="month-labels"></div>
            <div class="slider-track">
                <div class="slider-progress" id="slider-progress"></div>
                <input type="range" id="month-slider" min="0" max="11" value="0">
            </div>
            <div class="legend">
                <span class="legend-label">-20Â°C</span>
                <div class="legend-bar"></div>
                <span class="legend-label">40Â°C</span>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loading">Rendering temperature field...</div>
    <div class="loading-overlay" id="error" style="display:none; max-width: 520px; white-space: pre-wrap;"></div>

    <script src="temperature_data.js"></script>
    <script>
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const MONTH_FULL = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const MONTH_KEYS = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

        const DEG2RAD = Math.PI / 180;

        let map, citiesData = [], currentMonth = 0;
        let canvas, ctx;
        let canvasCssWidth = 0, canvasCssHeight = 0, canvasDpr = 1;
        let renderTimeout = null;
        let isMapReady = false;
        let isDataReady = false;

        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');

        function showError(message) {
            console.error(message);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else {
                alert(message);
            }
        }

        function isWebGLAvailable() {
            try {
                const c = document.createElement('canvas');
                return !!(c.getContext('webgl') || c.getContext('experimental-webgl'));
            } catch {
                return false;
            }
        }

        function wrapDeltaLngDegrees(delta) {
            // Normalize to [-180, 180)
            delta = ((delta + 180) % 360 + 360) % 360 - 180;
            return delta;
        }

        // Temperature to RGB color
        function tempToRGB(t) {
            t = Math.max(-20, Math.min(40, t));
            const stops = [
                [-20, 0, 68, 204],
                [-10, 0, 136, 255],
                [0, 0, 204, 255],
                [10, 0, 255, 204],
                [15, 68, 255, 136],
                [20, 136, 255, 68],
                [25, 204, 255, 0],
                [30, 255, 204, 0],
                [35, 255, 102, 0],
                [40, 204, 0, 34]
            ];
            for (let i = 0; i < stops.length - 1; i++) {
                if (t >= stops[i][0] && t <= stops[i + 1][0]) {
                    const ratio = (t - stops[i][0]) / (stops[i + 1][0] - stops[i][0]);
                    return [
                        Math.round(stops[i][1] + (stops[i + 1][1] - stops[i][1]) * ratio),
                        Math.round(stops[i][2] + (stops[i + 1][2] - stops[i][2]) * ratio),
                        Math.round(stops[i][3] + (stops[i + 1][3] - stops[i][3]) * ratio)
                    ];
                }
            }
            return [204, 0, 34];
        }

        // IDW interpolation for a single point
        function interpolateTemp(lat, lng, cities, monthKey) {
            let weightedSum = 0;
            let weightSum = 0;
            const power = 2;

            // Scale longitude degrees by cos(lat) so distances are closer to "real" on a sphere.
            const cosLat = Math.cos(lat * DEG2RAD);

            for (const city of cities) {
                const t = city[monthKey];
                if (t == null) continue;

                const dLat = city.lat - lat;
                const dLng = wrapDeltaLngDegrees(city.lng - lng) * cosLat;
                const dist2 = dLat * dLat + dLng * dLng;

                // If we're essentially on a city point, use it directly (avoids singular weights).
                if (dist2 < 0.25) return t; // ~0.5Â° threshold

                const weight = power === 2 ? (1 / dist2) : (1 / Math.pow(dist2, power / 2));
                weightedSum += t * weight;
                weightSum += weight;
            }

            return weightSum > 0 ? weightedSum / weightSum : null;
        }

        // Render temperature field to canvas
        function renderTemperatureField() {
            if (!citiesData.length || !map || !isMapReady) return;

            const cssWidth = canvasCssWidth || window.innerWidth;
            const cssHeight = canvasCssHeight || window.innerHeight;
            const deviceWidth = canvas.width;
            const deviceHeight = canvas.height;
            const monthKey = MONTH_KEYS[currentMonth];

            // Use lower resolution for performance, then scale up
            const scale = 4; // Render at 1/4 resolution
            const renderWidth = Math.ceil(cssWidth / scale);
            const renderHeight = Math.ceil(cssHeight / scale);

            const imageData = ctx.createImageData(renderWidth, renderHeight);
            const data = imageData.data;

            // Use all cities for interpolation so the field is always continuous (even over oceans).
            const visibleCities = citiesData;

            for (let y = 0; y < renderHeight; y++) {
                for (let x = 0; x < renderWidth; x++) {
                    // Convert pixel -> lat/lng using the map projection (Mercator correct, antimeridian safe).
                    const px = Math.min(cssWidth - 1, (x + 0.5) * scale);
                    const py = Math.min(cssHeight - 1, (y + 0.5) * scale);
                    const lngLat = map.unproject([px, py]);
                    const lng = lngLat.lng;
                    const lat = lngLat.lat;

                    const temp = interpolateTemp(lat, lng, visibleCities, monthKey);
                    const idx = (y * renderWidth + x) * 4;

                    if (temp !== null) {
                        const [r, g, b] = tempToRGB(temp);
                        data[idx] = r;
                        data[idx + 1] = g;
                        data[idx + 2] = b;
                        data[idx + 3] = 160; // Moderate alpha for visibility + map underneath
                    } else {
                        data[idx + 3] = 0; // Transparent
                    }
                }
            }

            // Create temporary canvas for scaling
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = renderWidth;
            tempCanvas.height = renderHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);

            // Scale up to full size with smoothing
            ctx.clearRect(0, 0, deviceWidth, deviceHeight);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(tempCanvas, 0, 0, deviceWidth, deviceHeight);
        }

        // Debounced render
        function scheduleRender() {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                if (!isMapReady || !isDataReady) return;

                if (loadingEl) loadingEl.style.display = 'block';

                // Allow the loading overlay to paint before heavy work.
                requestAnimationFrame(() => {
                    try {
                        renderTemperatureField();
                    } catch (err) {
                        console.error(err);
                    } finally {
                        if (loadingEl) loadingEl.style.display = 'none';
                    }
                });
            }, 100);
        }

        // Initialize map
        if (!window.maplibregl) {
            showError('Map library failed to load (maplibregl is missing). Check your network / ad-blocker.');
        } else if (!isWebGLAvailable()) {
            showError('WebGL is disabled or unavailable. MapLibre requires WebGL to render the map.');
        } else {
            try {
                // Use a CORS-friendly default style (Raster) as it's the most robust.
                const CARTO_RASTER_STYLE = {
                    version: 8,
                    sources: {
                        'carto-raster': {
                            type: 'raster',
                            tiles: [
                                'https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',
                                'https://b.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',
                                'https://c.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',
                                'https://d.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'
                            ],
                            tileSize: 256,
                            attribution: 'Â© OpenStreetMap contributors, Â© CARTO'
                        }
                    },
                    layers: [
                        { id: 'background', type: 'background', paint: { 'background-color': '#ff00ff' } },
                        { id: 'carto-raster', type: 'raster', source: 'carto-raster' }
                    ]
                };

                map = new maplibregl.Map({
                    container: 'map',
                    style: CARTO_RASTER_STYLE,
                    center: [0, 20],
                    zoom: 2,
                    minZoom: 1,
                    maxZoom: 8,
                    maxBounds: [[-180, -85], [180, 85]],
                    dragRotate: false,
                    pitchWithRotate: false
                });
            } catch (err) {
                showError('Map init failed: ' + (err && err.message ? err.message : String(err)));
            }
        }

        // Setup canvas
        canvas = document.getElementById('temp-canvas');
        if (canvas) {
            ctx = canvas.getContext('2d');
        }

        function resizeCanvas() {
            if (!canvas || !ctx) return;
            // IMPORTANT: cap DPR to reduce memory pressure on mobile (prevents WebGL map from disappearing).
            const dpr = Math.min(window.devicePixelRatio || 1, 2);

            const rect = canvas.getBoundingClientRect();
            const cssWidth = Math.round(rect.width);
            const cssHeight = Math.round(rect.height);
            if (!cssWidth || !cssHeight) return;

            canvasCssWidth = cssWidth;
            canvasCssHeight = cssHeight;
            canvasDpr = dpr;

            canvas.width = Math.round(cssWidth * dpr);
            canvas.height = Math.round(cssHeight * dpr);

            // Reset any transforms (defensive) and re-render.
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            if (map) map.resize();
            scheduleRender();
        }

        window.addEventListener('resize', resizeCanvas);
        if (window.visualViewport) {
            // Helps on mobile browsers where the visual viewport changes as the URL bar collapses/expands.
            window.visualViewport.addEventListener('resize', resizeCanvas);
        }
        resizeCanvas();

        // Map events
        if (map) {
            map.on('moveend', scheduleRender);
            map.on('zoomend', scheduleRender);
            map.on('load', () => {
                isMapReady = true;
                console.log('Map loaded');
                scheduleRender();
            });
            map.on('error', (e) => {
                console.warn('Map error:', e);
            });
        }

        // Zoom controls
        document.getElementById('zoom-in').onclick = () => map && map.zoomIn();
        document.getElementById('zoom-out').onclick = () => map && map.zoomOut();

        // Month labels
        const labelsContainer = document.getElementById('month-labels');
        MONTHS.forEach((m, i) => {
            const span = document.createElement('span');
            span.textContent = m;
            if (i === 0) span.classList.add('active');
            span.onclick = () => { document.getElementById('month-slider').value = i; setMonth(i); };
            labelsContainer.appendChild(span);
        });

        function setMonth(m) {
            currentMonth = m;
            document.getElementById('current-month').textContent = MONTH_FULL[m];
            document.getElementById('slider-progress').style.width = (m / 11 * 100) + '%';
            document.querySelectorAll('#month-labels span').forEach((s, i) => s.classList.toggle('active', i === m));
            updateStats();
            scheduleRender();
        }

        function updateStats() {
            if (!citiesData.length) return;
            const temps = citiesData.map(c => c[MONTH_KEYS[currentMonth]]).filter(t => t != null);
            if (!temps.length) return;
            document.getElementById('stat-hottest').textContent = Math.max(...temps).toFixed(1) + 'Â°C';
            document.getElementById('stat-coldest').textContent = Math.min(...temps).toFixed(1) + 'Â°C';
            document.getElementById('stat-average').textContent = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) + 'Â°C';
        }

        document.getElementById('month-slider').oninput = e => setMonth(parseInt(e.target.value));

        function setCitiesData(data) {
            citiesData = (data && data.cities) ? data.cities : [];
            isDataReady = citiesData.length > 0;
            console.log('Loaded', citiesData.length, 'cities');
            updateStats();
            scheduleRender();
        }

        // Load data (prefer JS global for file:// compatibility; fallback to fetch).
        if (window.TEMPERATURE_DATA && window.TEMPERATURE_DATA.cities) {
            setCitiesData(window.TEMPERATURE_DATA);
        } else {
            fetch('temperature_data.json')
                .then(r => r.json())
                .then(setCitiesData)
                .catch(err => {
                    const msg = (err && err.message) ? err.message : String(err);
                    console.error('Fetch failed:', msg);
                });
        }
    </script>
</body>

</html>